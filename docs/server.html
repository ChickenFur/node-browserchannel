<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This is a browserchannel server.</p>

<ul>
<li>It doesn't work yet.</li>
<li>It is missing tests</li>
</ul>

<p>The server is implemented as connect middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><code>parse</code> helps us decode URLs in requests</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">parse</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;url&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><code>randomInt(k)</code> generates and returns a random int smaller than <em>n</em> (0 &lt;= k &lt; n)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomInt = </span><span class="nf">(n) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">n</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>randomArrayElement(array)</code> Selects and returns a random element from <em>array</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomArrayElement = </span><span class="nf">(array) -&gt;</span> <span class="nx">array</span><span class="p">[</span><span class="nx">randomInt</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The module is configurable</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">defaultOptions =</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>An optional array of host prefixes. Each browserchannel client will randomly pick
from the list of host prefixes when it connects. This reduces the impact of per-host
connection limits.</p>

<p>All host prefixes should point to the same server. Ie, if your server's hostname
is <em>example.com</em> and your hostPrefixes contains ['a', 'b', 'c'],
a.example.com, b.example.com and c.example.com should all point to the same host
as example.com.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">hostPrefixes: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>You can specify the base URL which browserchannel connects to. Change this if you want
to scope browserchannel in part of your app, or if you want /channel to mean something
else, or whatever.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">base: </span><span class="s1">&#39;/channel&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The server module returns a function, which you can call with your configuration
options. It returns your configured connect middleware, which is actually another function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="nf">(options, onConnect) -&gt;</span>
	<span class="k">if</span> <span class="k">typeof</span> <span class="nx">client</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span>
		<span class="nv">client = </span><span class="nx">options</span>
		<span class="nv">options = </span><span class="p">{}</span>

	<span class="nx">options</span> <span class="o">||=</span> <span class="p">{}</span>
	<span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">||=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">option</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">defaultOptions</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Strip off a trailing slash in base.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">base = </span><span class="nx">options</span><span class="p">.</span><span class="nx">base</span>
	<span class="nv">base = </span><span class="nx">base</span><span class="p">[...</span> <span class="nx">base</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\/$/</span>

	<span class="nv">clients = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This is the returned middleware. Connect middleware is a function which
takes in an http request, an http response and a next method.</p>

<p>The middleware can do one of two things:</p>

<ul>
<li>Handle the request, sending data back to the server via the response</li>
<li>Call <code>next()</code>, which allows the next middleware in the stack a chance to
handle the request.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nf">(req, res, next) -&gt;</span>
		<span class="nv">query = </span><span class="nx">parse</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span>
		<span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">base</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">base</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This server only supports browserchannel protocol version 8.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s1">&#39;VER&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;8&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>I'm not sure which HTTP error code to send.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>All responses have a standard set of HTTP headers.
To be honest, I don't know how many of these are necessary. I just copied
them from google.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">standardHeaders =</span>
			<span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span>
			<span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache, no-store, max-age=0, must-revalidate&#39;</span>
			<span class="s1">&#39;Pragma&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache&#39;</span>
			<span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="o">:</span> <span class="s1">&#39;nosniff&#39;</span>
			<span class="s1">&#39;Expires&#39;</span><span class="o">:</span> <span class="s1">&#39;Fri, 01 Jan 1990 00:00:00 GMT&#39;</span>

		<span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s2">&quot;#{base}/test&quot;</span>
			<span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s1">&#39;MODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span> <span class="o">and</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Connection test - phase 1</h3>

<p>The client is requesting host prefixes. The server responds with an array of
['hostprefix' or null, 'blockedprefix' or null].</p>

<ul>
<li><p><strong>hostprefix</strong> is subdomain prepended onto the hostname of each request.
This gets around browser connection limits. Using this requires a bank of
configured DNS entries and SSL certificates if you're using HTTPS.</p></li>
<li><p><strong>blockedprefix</strong> provides network admins a way to blacklist browserchannel requests.
It is not supported by node-browserchannel.</p></li>
</ul>

<p>This request is <strong>stateless</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">hostPrefix = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hostPrefixes</span>
					<span class="nx">randomArrayElement</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hostPrefixes</span>
				<span class="k">else</span>
					<span class="kc">null</span>

				<span class="nv">blockedPrefix = </span><span class="kc">null</span> <span class="c1"># Blocked prefixes aren&#39;t supported by this module</span>

				<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">[</span><span class="nx">hostPrefix</span><span class="p">,</span> <span class="nx">blockedPrefix</span><span class="p">])</span>

			<span class="k">else</span> <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="s1">&#39;TYPE&#39;</span><span class="p">]</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;xmlhttp&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>Connection test - phase 2</h3>

<p>The client is trying to determine if their connection is buffered or unbuffered.
We reply with '11111', then 2 seconds later '2'.</p>

<p>The client should get the data in 2 chunks - but they won't if there's a misbehaving
corporate proxy in the way or something.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">standardHeaders</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;11111&#39;</span>
				<span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span> <span class="mi">2000</span>

			<span class="k">else</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">400</span><span class="p">,</span> <span class="nx">standardHeaders</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;Bad request&quot;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s2">&quot;#{base}/bind&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This is a channel request.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">query</span>

		<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>We'll 404 the user instead of letting another handler take care of it.
Users shouldn't be using the specified URL prefix for anything else.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">404</span><span class="p">,</span> <span class="nx">standardHeaders</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;Not found&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 