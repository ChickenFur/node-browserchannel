<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This is a BrowserChannel server.</p>

<ul>
<li>-It doesn't work yet-.</li>
<li>It is missing tests</li>
</ul>

<p>The server is implemented as connect middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><code>parse</code> helps us decode URLs in requests</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">parse</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;url&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><code>querystring</code> will help decode the URL-encoded forward channel data</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">querystring = </span><span class="nx">require</span> <span class="s1">&#39;querystring&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Client sessions are `EventEmitters</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">EventEmitter</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;events&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Client session Ids are generated using <code>node-hat</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">hat = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;hat&#39;</span><span class="p">).</span><span class="nx">rack</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>randomInt(n)</code> generates and returns a random int smaller than n (0 &lt;= k &lt; n)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomInt = </span><span class="nf">(n) -&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">n</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>randomArrayElement(array)</code> Selects and returns a random element from <em>array</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomArrayElement = </span><span class="nf">(array) -&gt;</span> <span class="nx">array</span><span class="p">[</span><span class="nx">randomInt</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The module is configurable</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">defaultOptions =</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>An optional array of host prefixes. Each browserchannel client will randomly pick
from the list of host prefixes when it connects. This reduces the impact of per-host
connection limits.</p>

<p>All host prefixes should point to the same server. Ie, if your server's hostname
is <em>example.com</em> and your hostPrefixes contains ['a', 'b', 'c'],
a.example.com, b.example.com and c.example.com should all point to the same host
as example.com.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">hostPrefixes: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>You can specify the base URL which browserchannel connects to. Change this if you want
to scope browserchannel in part of your app, or if you want /channel to mean something
else, or whatever.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">base: </span><span class="s1">&#39;/channel&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>We'll send keepalives every so often to make sure the http connection isn't closed by
eagar clients. The standard timeout is 30 seconds, so we'll default to sending them
every 20 seconds or so.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">keepAliveInterval: </span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>All server responses set some standard HTTP headers.
To be honest, I don't know how many of these are necessary. I just copied
them from google.</p>

<p>The nocache headers in particular seem unnecessary since each client
request includes a randomized <code>zx=junk</code> query parameter.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">standardHeaders =</span>
	<span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span>
	<span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache, no-store, max-age=0, must-revalidate&#39;</span>
	<span class="s1">&#39;Pragma&#39;</span><span class="o">:</span> <span class="s1">&#39;no-cache&#39;</span>
	<span class="s1">&#39;Expires&#39;</span><span class="o">:</span> <span class="s1">&#39;Fri, 01 Jan 1990 00:00:00 GMT&#39;</span>
	<span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="o">:</span> <span class="s1">&#39;nosniff&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Google's browserchannel server adds some junk after the first message data is sent. I
assume this stops some whole-page buffering in IE. I assume the data used is noise so it
doesn't compress.</p>

<p>I don't really know why google does this. I'm assuming there's a good reason to it though.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ieJunk = </span><span class="s2">&quot;&quot;&quot;7cca69475363026330a0d99468e88d23ce95e222591126443015f5f462d9a177186c8701fb45a6ffe</span>
<span class="s2">e0daf1a178fc0f58cd309308fba7e6f011ac38c9cdd4580760f1d4560a84d5ca0355ecbbed2ab715a3350fe0c4790</span>
<span class="s2">50640bd0e77acec90c58c4d3dd0f5cf8d4510e68c8b12e087bd88cad349aafd2ab16b07b0b1b8276091217a44a9fe</span>
<span class="s2">92fedacffff48092ee693af\n&quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If the user is using IE, instead of using XHR backchannel loaded using
a forever iframe. When data is sent, it is wrapped in <script></script> tags
which call functions in the browserchannel library.</p>

<p>This method wraps the normal <code>.writeHead()</code>, <code>.write()</code> and <code>.end()</code> methods by
special versions which produce output based on the request's type.</p>

<p>This <strong>is not used</strong> for:</p>

<ul>
<li>The first channel test</li>
<li>The first <em>bind</em> connection a client makes. The server sends arrays there, but the
connection is a POST and it returns immediately. So that request happens using XHR/Trident
like regular forward channel requests.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">messagingMethods = </span><span class="nf">(type, res) -&gt;</span>
	<span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span>
		<span class="nv">junkSent = </span><span class="kc">false</span>

		<span class="nv">writeHead: </span><span class="o">-&gt;</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;&lt;html&gt;&lt;body&gt;&#39;</span>

			<span class="nv">domain = </span><span class="nx">query</span><span class="p">.</span><span class="nx">DOMAIN</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If the iframe is making the request using a secondary domain, I think we need
to set the <code>domain</code> to the original domain so that we can call the response methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">domain</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Make sure the domain doesn't contain anything by naughty by <code>JSON.stringify()</code>-ing
it before passing it to the client. There are XSS vulnerabilities otherwise.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">domain = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">domain</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;&lt;script&gt;try{document.domain=#{domain};}catch(e){}&lt;/script&gt;\n&quot;</span>
	
		<span class="nv">write: </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The data is passed to <code>m()</code>, which is bound to <em>onTridentRpcMessage_</em> in the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;&lt;script&gt;try {parent.m(\&quot;#{data}\&quot;)} catch(e){}&lt;/script&gt;\n&quot;</span>
			<span class="nx">unless</span> <span class="nx">junkSent</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="nx">ieJunk</span>
				<span class="nv">junkSent = </span><span class="kc">true</span>

		<span class="nv">end: </span><span class="nf">(data) -&gt;</span>
			<span class="nx">write</span> <span class="nx">data</span> <span class="k">if</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Once the data has been received, the client needs to call <code>d()</code>, which is bound to
<em>onTridentDone_</em> with success=<em>true</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;&lt;script&gt;try {parent.d()} catch(e){}&lt;/script&gt;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This is a helper method for signalling an error in the request back to the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">signalError: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>The HTML (iframe) handler has no way to discover that the embedded script tag
didn't complete successfully. To signal errors, we return <strong>200 OK</strong> and call an
exposed rpcClose() method on the page.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">writeHead</span><span class="p">()</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;&lt;script&gt;try {parent.m(\&quot;#{data}\&quot;)} catch(e){}&lt;/script&gt;\n&quot;</span>

	<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>For normal XHR requests, we send data normally.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">writeHead: </span><span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
		<span class="nv">write: </span><span class="nf">(data) -&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="nx">data</span>
		<span class="nv">end: </span><span class="nf">(data) -&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">data</span>
		<span class="nv">signalError: </span><span class="nf">(statusCode, message) -&gt;</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="nx">standardHeaders</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Parsing client maps from the forward channel</h2>

<p>The client sends data in a series of url-encoded maps. The data is encoded like this:</p>

<p><code>
count=2&amp;ofs=0&amp;req0_x=3&amp;req0_y=10&amp;req1_abc=def
</code></p>

<p>First, we need to buffer up the request response and query string decode it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">bufferPostData = </span><span class="nf">(req, callback) -&gt;</span>
	<span class="nv">data = </span><span class="p">[]</span>
	<span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
		<span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span> <span class="s1">&#39;utf8&#39;</span>
	<span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
		<span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span>
		<span class="nx">callback</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Next, we'll need to decode the querystring-encoded maps into an array of objects.</p>

<p>When this function is called, the data is in this form:</p>

<p><code>
{ count: '2',
  ofs: '0',
  req0_x: '3',
  req0_y: '10',
  req1_abc: 'def'
}
</code></p>

<p>... and we will return an object in the form of <code>[{x:'3', y:'10'}, {abc: 'def'}]</code></p>

<p>I really wish they'd just used JSON. I guess this lets you submit forward channel
data using just a GET request if you really want to. I wonder if thats how early
versions of browserchannel worked...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">decodeMaps = </span><span class="nf">(data) -&gt;</span>
	<span class="nv">count = </span><span class="nb">parseInt</span> <span class="nx">data</span><span class="p">.</span><span class="nx">count</span>
	<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Invalid maps&#39;</span> <span class="nx">unless</span> <span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">or</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ofs</span><span class="o">?</span><span class="p">)</span>

	<span class="nv">maps = </span><span class="k">new</span> <span class="nb">Array</span> <span class="nx">count</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Scan through all the keys in the data. Every key of the form:
<code>req123_xxx</code> will be used to populate its map.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">regex = </span><span class="sr">/^req(\d+)_(.+)$/</span>
	<span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">data</span>
		<span class="nv">match = </span><span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">key</span>
		<span class="k">if</span> <span class="nx">match</span>
			<span class="nv">id = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="nv">mapKey = </span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
			<span class="nv">map = </span><span class="p">(</span><span class="nx">maps</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">||=</span> <span class="p">{})</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The client uses <code>mapX_type=_badmap</code> to signify an error encoding a map.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">continue</span> <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;type&#39;</span> <span class="o">and</span> <span class="nx">mapKey</span> <span class="o">==</span> <span class="s1">&#39;_badmap&#39;</span>
			<span class="nx">map</span><span class="p">[</span><span class="nx">mapKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>

	<span class="nx">maps</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The server module returns a function, which you can call with your configuration
options. It returns your configured connect middleware, which is actually another function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="nf">(options, onConnect) -&gt;</span>
	<span class="k">if</span> <span class="k">typeof</span> <span class="nx">onConnect</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span>
		<span class="nv">onConnect = </span><span class="nx">options</span>
		<span class="nv">options = </span><span class="p">{}</span>

	<span class="nx">options</span> <span class="o">||=</span> <span class="p">{}</span>
	<span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">||=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">option</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">defaultOptions</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Strip off a trailing slash in base.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">base = </span><span class="nx">options</span><span class="p">.</span><span class="nx">base</span>
	<span class="nv">base = </span><span class="nx">base</span><span class="p">[...</span> <span class="nx">base</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\/$/</span>

	<span class="nv">clients = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Host prefixes provide a way to skirt around connection limits. They're only
really important for old browsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">getHostPrefix = </span><span class="o">-&gt;</span>
		<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hostPrefixes</span>
			<span class="nx">randomArrayElement</span> <span class="nx">options</span><span class="p">.</span><span class="nx">hostPrefixes</span>
		<span class="k">else</span>
			<span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h1>Create a new client session.</h1>

<p>This method will start a new client session. It is called in two different ways:</p>

<ul>
<li>A new client is connecting for the first time</li>
<li>A client is reconnecting a dropped connection. In this case, the client provides
their previous <em>sessionId</em> and <em>arrayId</em>.</li>
</ul>

<p>Session ids are generated by <a href="https://github.com/substack/node-hat">node-hat</a>. They are guaranteed to be unique.
This method is synchronous, because a database will never be involved in browserchannel
session management. Browserchannel sessions only last as long as the user's browser
is open. If there's any connection turbulence, the client will reconnect and get
a new session id.</p>

<p>I'm not sure what should happen if there's an old <em>sessionId</em> that we still know about.
Presumably, we rename the old session and pretend nothing happened... though I imagine
its a bit more complicated than that. I'll have to read more of the code.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">createClient = </span><span class="nf">(address, appVersion, oldSessionId, oldArrayId) -&gt;</span>
		<span class="k">if</span> <span class="nx">oldSessionId</span><span class="o">?</span>
			<span class="nv">client = </span><span class="nx">clients</span><span class="p">[</span><span class="nx">oldSessionId</span><span class="p">]</span>
			<span class="k">if</span> <span class="nx">client</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We create a new session id for the client and send any pending arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">client.id = </span><span class="nx">hat</span><span class="p">()</span>

				<span class="nx">client</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;reconnected&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Resending arrays isn't implemented yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Not implemented&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We probably need to reset the client's rid and all sorts of nonsense.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="nx">client</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Otherwise we'll just create a new client like normal. I'm not sure if
we ever tell the client that we have no idea about its old sessionId.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Create a new client. Clients extend node's <a href="http://nodejs.org/docs/v0.4.12/api/events.html">EventEmitter</a> so they have access to
goodies like <code>client.on(event, handler)</code>, <code>client.emit('paarty')</code>, etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client = </span><span class="k">new</span> <span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>The client's unique ID for this connection</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.id = </span><span class="nx">hat</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The client is a big ol' state machine. It has the following states:</p>

<ul>
<li><p><strong>init</strong>: The client has been created and its sessionId hasn't been sent yet.
The client moves to the <strong>connected</strong> state almost immediately.</p></li>
<li><p><strong>connected</strong>: The client is sitting pretty and ready to send and receive data.
The client should spend most of its time in this state.</p></li>
<li><p><strong>stopped</strong>: The client is invalid for some reason. The client stays in this
state just long enough to tell the client to stop connecting and tell the
application that the client is going to be destroyed. Then the client is becomes
<strong>dead</strong> and its removed from the session list.</p></li>
<li><p><strong>dead</strong>: The client has been removed from the session list. It can no longer
be used for any reason.</p>

<p>It is invalid to send arrays to a client while it is stopped or dead. Unless you're
Bruce Willis...</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.state = </span><span class="s1">&#39;init&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>The state is modified through this method. It emits events when the state changes.
(yay)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.changeState = </span><span class="nf">(newState) -&gt;</span>
			<span class="nv">oldState = </span><span class="nx">@state</span>
			<span class="vi">@state = </span><span class="nx">newState</span>
			<span class="nx">@emit</span> <span class="nx">@state</span><span class="p">,</span> <span class="nx">oldState</span>

			<span class="k">if</span> <span class="nx">newState</span> <span class="o">==</span> <span class="s1">&#39;stopped&#39;</span>
				<span class="nx">client</span><span class="p">.</span><span class="nx">queueArray</span> <span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>The server sends messages to the client via a hanging GET request. Of course,
the client has to be the one to open that request.</p>

<p>This is a handle to that request.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.setBackChannel = </span><span class="nf">(res, query) -&gt;</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Invalid backchannel headers&#39;</span> <span class="nx">unless</span> <span class="nx">query</span><span class="p">.</span><span class="nx">RID</span> <span class="o">==</span> <span class="s1">&#39;rpc&#39;</span>

			<span class="vi">@backChannel = </span><span class="nx">res</span>
			<span class="vi">@backChannelMethods = </span><span class="nx">messagingMethods</span> <span class="nx">query</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">,</span> <span class="nx">res</span>
			<span class="vi">@chunk = </span><span class="nx">query</span><span class="p">.</span><span class="nx">CI</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>If we haven't sent anything for 30 seconds, we'll send a little <code>['noop']</code> to the
client to make sure we haven't forgotten it. (And to make sure the backchannel
connection doesn't time out.)</p>

<p>Its possible that a little bit of noise on the network connection (but not at the
application level) will make this setTimeout not fire sometimes. Its not a big
deal anyway - the client will just reopen it.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">res</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">options</span><span class="p">.</span><span class="nx">keepAliveInterval</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="p">[</span><span class="s1">&#39;noop&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Send any arrays we've buffered now that we have a backchannel</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">client</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>

			<span class="nx">res</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Sad.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">client.backChannel = client.backChannelMethods = </span><span class="kc">null</span>

		<span class="nv">client.refreshHeartbeat = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>The server sends data to the client by sending <em>arrays</em>. It seems a bit silly that
client->server messages are maps and server->client messages are arrays, but there it is.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.outgoingArrays = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p><code>lastArrayId</code> is the array ID of the last queued array</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.lastArrayId = </span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Every request from the client has an <em>AID</em> parameter which tells the server the ID
of the last request the client has received. We won't remove arrays from the outgoingArrays
list until the client has confirmed its received them.</p>

<p>In <code>lastSentArrayId</code> we store the ID of the last array which we actually sent.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.lastSentArrayId = </span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>The arrays get removed once they've been acknowledged</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.acknowledgedArrays = </span><span class="nf">(id) -&gt;</span>
			<span class="nx">@outgoingArrays</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">while</span> <span class="nx">@outgoingArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">@outgoingArrays</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Queue an array to be sent</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.queueArray = </span><span class="nf">(arr) -&gt;</span>
			<span class="k">if</span> <span class="nx">client</span><span class="p">.</span><span class="nx">state</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;dead&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">]</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Cannot queue array when state is #{@state}&quot;</span>

			<span class="nx">@outgoingArrays</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="o">++</span><span class="nx">@lastArrayId</span><span class="p">,</span> <span class="nx">arr</span><span class="p">]</span> <span class="c1"># MOAR Arrays! The people demand it!</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Figure out how many unacknowledged arrays are hanging around in the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.unacknowledgedArrays = </span><span class="o">-&gt;</span>
			<span class="nv">numUnsentArrays = </span><span class="nx">client</span><span class="p">.</span><span class="nx">lastArrayId</span> <span class="o">-</span> <span class="nx">client</span><span class="p">.</span><span class="nx">lastSentArrayId</span>
			<span class="nx">client</span><span class="p">.</span><span class="nx">outgoingArrays</span><span class="p">[...</span> <span class="nx">client</span><span class="p">.</span><span class="nx">outgoingArrays</span> <span class="o">-</span> <span class="nx">numUnsentArrays</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>The session has just been created. The first thing it needs to tell the client
is its session id and host prefix and stuff.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">client</span><span class="p">.</span><span class="nx">queueArray</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">getHostPrefix</span><span class="p">(),</span> <span class="mi">8</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h2>Encoding server arrays for the back channel</h2>

<p>The server sends data to the client in <strong>chunks</strong>. Each chunk is a <em>JSON</em> array prefixed
by its length in bytes.</p>

<p>The array looks like this:</p>

<p><code>
[
  [100, ['message', 'one']],
  [101, ['message', 'two']],
  [102, ['message', 'three']]
]
</code></p>

<p>Each individial message is prefixed by its <em>array id</em>, which is a counter starting at 0
when the session is first created and incremented with each array.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.sendTo = </span><span class="nf">(channel, write) -&gt;</span>
			<span class="nv">numUnsentArrays = </span><span class="nx">client</span><span class="p">.</span><span class="nx">lastArrayId</span> <span class="o">-</span> <span class="nx">client</span><span class="p">.</span><span class="nx">lastSentArrayId</span>
			<span class="k">if</span> <span class="nx">numUnsentArrays</span> <span class="o">&gt;</span> <span class="mi">0</span>
				<span class="nv">arrays = </span><span class="nx">client</span><span class="p">.</span><span class="nx">outgoingArrays</span><span class="p">[</span><span class="nx">client</span><span class="p">.</span><span class="nx">outgoingArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">numUnsentArrays</span> <span class="p">...]</span>

				<span class="nv">json = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">arrays</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p><strong>Away!</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">write</span> <span class="s2">&quot;#{json.length}\n#{json}&quot;</span>

				<span class="nv">client.lastSentArrayId = </span><span class="nx">client</span><span class="p">.</span><span class="nx">lastArrayId</span>

			<span class="nx">numUnsentArrays</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Queue the arrays to be sent on the next tick</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.flush = </span><span class="o">-&gt;</span>
			<span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">-&gt;</span>
				<span class="k">if</span> <span class="nx">client</span><span class="p">.</span><span class="nx">backChannel</span>
					<span class="nv">sentSomething = </span><span class="nx">client</span><span class="p">.</span><span class="nx">sendTo</span> <span class="nx">client</span><span class="p">.</span><span class="nx">backChannel</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">backChannelMethods</span><span class="p">.</span><span class="nx">write</span>
					<span class="nx">client</span><span class="p">.</span><span class="nx">backChannelMethods</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span> <span class="k">if</span> <span class="o">!</span><span class="nx">client</span><span class="p">.</span><span class="nx">chunk</span> <span class="o">and</span> <span class="nx">sentSomething</span>
					
		<span class="nv">client.send = </span><span class="nf">(arr) -&gt;</span>
			<span class="nx">@queueArray</span> <span class="nx">arr</span>
			<span class="nx">@flush</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>The client's IP address when it first opened the session</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.address = </span><span class="nx">address</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>The client's reported application version, or null. This is sent when the
connection is first requested, so you can use it to make your application die / stay
compatible with people who don't close their browsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.appVersion = </span><span class="nx">appVersion</span> <span class="k">if</span> <span class="nx">appVersion</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Stop the client's connections and make it die. This will send the special
'stop' signal to the client, which will cause it to stop trying to reconnect.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.stop = </span><span class="o">-&gt;</span>
			<span class="nx">@changeState</span> <span class="s1">&#39;stop&#39;</span>
			<span class="nx">@close</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>This closes a client's connections and makes the server forget about it.
The client will probably try and reconnect if you simply close its connections.
It'll get a new client object when it does so.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.close = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>... close all connections and stuff.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Send the client array data through the backchannel</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.sendArray = </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Remind everybody that the client is still alive and ticking. If the client
doesn't see any traffic for awhile, it'll get deleted and the browser will just have
to reconnect.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">client.touch = </span><span class="o">-&gt;</span>

		<span class="nx">clients</span><span class="p">[</span><span class="nx">client</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">client</span>

		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Created a new client #{client.id} from #{client.address}&quot;</span>

		<span class="nx">client</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>This is the returned middleware. Connect middleware is a function which
takes in an http request, an http response and a next method.</p>

<p>The middleware can do one of two things:</p>

<ul>
<li>Handle the request, sending data back to the server via the response</li>
<li>Call <code>next()</code>, which allows the next middleware in the stack a chance to
handle the request.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nf">(req, res, next) -&gt;</span>
		<span class="p">{</span><span class="nx">query</span><span class="p">,</span> <span class="nx">pathname</span><span class="p">}</span> <span class="o">=</span> <span class="nx">parse</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span>
		<span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="k">if</span> <span class="nx">pathname</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">base</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">base</span>

		<span class="p">{</span><span class="nx">writeHead</span><span class="p">,</span> <span class="nx">write</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">signalError</span><span class="p">}</span> <span class="o">=</span> <span class="nx">messagingMethods</span> <span class="nx">query</span><span class="p">.</span><span class="nx">TYPE</span><span class="p">,</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>This server only supports browserchannel protocol version <strong>8</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">VER</span> <span class="o">!=</span> <span class="s1">&#39;8&#39;</span>
			<span class="nx">signalError</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;Only version 8 is supported&#39;</span> <span class="c1"># Is 400 appropriate here?</span>
			<span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h1>Connection testing</h1>

<p>Before the browserchannel client connects, it tests the connection to make
sure its working, and to look for buffering proxies.</p>

<p>The server-side code for connection testing is completely stateless.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">pathname</span> <span class="o">==</span> <span class="s2">&quot;#{base}/test&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <h3>Phase 1: Server info</h3>

<p>The client is requests host prefixes. The server responds with an array of
['hostprefix' or null, 'blockedprefix' or null].</p>

<ul>
<li><p><strong>hostprefix</strong> is subdomain prepended onto the hostname of each request.
This gets around browser connection limits. Using this requires a bank of
configured DNS entries and SSL certificates if you're using HTTPS.</p></li>
<li><p><strong>blockedprefix</strong> provides network admins a way to blacklist browserchannel
requests. It is not supported by node-browserchannel.</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">MODE</span> <span class="o">==</span> <span class="s1">&#39;init&#39;</span> <span class="o">and</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span>
				<span class="nv">hostPrefix = </span><span class="nx">getHostPrefix</span><span class="p">()</span>
				<span class="nv">blockedPrefix = </span><span class="kc">null</span> <span class="c1"># Blocked prefixes aren&#39;t supported.</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>This is a straight-up normal HTTP request like the forward channel requests.
We don't use the funny iframe write methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">[</span><span class="nx">hostPrefix</span><span class="p">,</span> <span class="nx">blockedPrefix</span><span class="p">])</span>

			<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h3>Phase 2: Buffering proxy detection</h3>

<p>The client is trying to determine if their connection is buffered or unbuffered.
We reply with '11111', then 2 seconds later '2'.</p>

<p>The client should get the data in 2 chunks - but they won't if there's a misbehaving
corporate proxy in the way or something.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">writeHead</span><span class="p">()</span>
				<span class="nx">write</span> <span class="s1">&#39;11111&#39;</span>
				<span class="nx">setTimeout</span> <span class="p">(</span><span class="o">-&gt;</span> <span class="nx">end</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span> <span class="mi">2000</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <h1>BrowserChannel connection</h1>

<p>Once a client has finished testing its connection, it connects.</p>

<p>BrowserChannel communicates through two connections:</p>

<ul>
<li>The <strong>forward channel</strong> is used for the client to send data to the server.
It uses a <strong>POST</strong> request for each message.</li>
<li>The <strong>back channel</strong> is used to get data back from the server. This uses a
hanging <strong>GET</strong> request. If chunking is disallowed (ie, if the proxy buffers)
then the back channel is closed after each server message.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">pathname</span> <span class="o">==</span> <span class="s2">&quot;#{base}/bind&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>All browserchannel connections have an associated client object. A client
is created immediately if the connection is new.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">SID</span>
				<span class="nv">client = </span><span class="nx">clients</span><span class="p">[</span><span class="nx">query</span><span class="p">.</span><span class="nx">SID</span><span class="p">]</span>
				<span class="nx">unless</span> <span class="nx">client</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>This is a special error code for the client. It tells the client to abandon its
connection request and reconnect.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">signalError</span> <span class="s1">&#39;400&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown SID&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h3>Forward Channel</h3>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span>
				<span class="k">if</span> <span class="nx">client</span> <span class="o">==</span> <span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>The client is new! Make them a new client object and let the
application know.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nv">client = </span><span class="nx">createClient</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="nx">query</span><span class="p">.</span><span class="nx">CVER</span><span class="p">,</span> <span class="nx">query</span><span class="p">.</span><span class="nx">OSID</span><span class="p">,</span> <span class="nx">query</span><span class="p">.</span><span class="nx">OAID</span><span class="p">)</span>
					<span class="nx">onConnect</span><span class="o">?</span> <span class="nx">client</span>
					<span class="nv">init = </span><span class="kc">true</span>

				<span class="nx">client</span><span class="p">.</span><span class="nx">acknowledgedArrays</span> <span class="nx">query</span><span class="p">.</span><span class="nx">AID</span> <span class="k">if</span> <span class="nx">query</span><span class="p">.</span><span class="nx">AID</span><span class="o">?</span>

				<span class="nx">bufferPostData</span> <span class="nx">req</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
					<span class="nv">maps = </span><span class="nx">decodeMaps</span> <span class="nx">data</span>
					<span class="nx">client</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="nx">map</span> <span class="k">for</span> <span class="nx">map</span> <span class="k">in</span> <span class="nx">maps</span> <span class="nx">unless</span> <span class="nx">client</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span>

					<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>On the initial request, we send any pending server arrays to the client.
This is important because it tells the client what its session id is.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="nx">init</span>
						<span class="nx">client</span><span class="p">.</span><span class="nx">sendTo</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">write</span>
						<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
					<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>On normal forward channels, we reply to the request by telling the client
if our backchannel is still live and telling it how many unconfirmed
arrays we have.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="nv">unacknowledgedArrays = </span><span class="nx">client</span><span class="p">.</span><span class="nx">unacknowledgedArrays</span><span class="p">()</span>
						<span class="nv">outstandingBytes = </span><span class="k">if</span> <span class="nx">unacknowledgedArrays</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
							<span class="mi">0</span>
						<span class="k">else</span>
							<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">unacknowledgedArrays</span><span class="p">).</span><span class="nx">length</span>

						<span class="nv">response = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">[</span><span class="nx">client</span><span class="p">.</span><span class="nx">backChannel</span><span class="o">?</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">lastSentArrayId</span><span class="p">,</span> <span class="nx">outstandingBytes</span><span class="p">]</span>
						<span class="nx">end</span> <span class="s2">&quot;#{response.length}\n#{response}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <h3>Back Channel</h3>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span> <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;invalid SID&#39;</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">query</span><span class="p">.</span><span class="nx">SID</span> <span class="o">!=</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">query</span><span class="p">.</span><span class="nx">SID</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">5</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;Session not specified&#39;</span> <span class="nx">unless</span> <span class="nx">client</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>console.log 'Back channel:', query</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">writeHead</span><span class="p">()</span>
				<span class="nx">client</span><span class="p">.</span><span class="nx">setBackChannel</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">query</span>

			<span class="k">else</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">405</span><span class="p">,</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;Method not allowed&quot;</span>
				

		<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>We'll 404 the user instead of letting another handler take care of it.
Users shouldn't be using the specified URL prefix for anything else.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="nx">standardHeaders</span>
			<span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s2">&quot;Not found&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 